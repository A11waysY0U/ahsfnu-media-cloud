<Page x:Class="MediaCloudDesktop.Views.MaterialsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      Title="素材管理">
    
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 标题和上传按钮 -->
        <Grid Grid.Row="0" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <TextBlock Text="素材管理" 
                     FontSize="24" 
                     FontWeight="Bold" 
                     VerticalAlignment="Center"
                     Foreground="#303133"/>
            
            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                <ComboBox x:Name="UploadWorkflowComboBox"
                          Width="140"
                          Style="{StaticResource ModernComboBox}"
                          Margin="0,0,10,0">
                    <ComboBoxItem Style="{StaticResource ModernComboBoxItem}" Content="不指定工作流" Tag="__none__" IsSelected="True"/>
                </ComboBox>
                <Button x:Name="UploadButton" 
                        Content="上传素材" 
                        Style="{StaticResource ModernButton}"
                        Click="UploadButton_Click"/>
            </StackPanel>
        </Grid>

        <!-- 搜索和筛选 -->
        <Grid Grid.Row="1" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200"/>
                <ColumnDefinition Width="150"/>
                <ColumnDefinition Width="150"/>
                <ColumnDefinition Width="150"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBox x:Name="SearchTextBox" 
                   Grid.Column="0"
                   Style="{StaticResource ModernTextBox}"
                   Margin="0,0,10,0"
                   TextChanged="SearchTextBox_TextChanged"
                   ToolTip="搜索素材名称"/>

            <ComboBox x:Name="FileTypeComboBox" 
                    Grid.Column="1"
                    Style="{StaticResource ModernComboBox}"
                    Margin="0,0,10,0"
                    SelectionChanged="FileTypeComboBox_SelectionChanged">
                <ComboBoxItem Style="{StaticResource ModernComboBoxItem}" Content="全部类型" IsSelected="True"/>
                <ComboBoxItem Style="{StaticResource ModernComboBoxItem}" Content="图片"/>
                <ComboBoxItem Style="{StaticResource ModernComboBoxItem}" Content="视频"/>
                <ComboBoxItem Style="{StaticResource ModernComboBoxItem}" Content="音频"/>
                <ComboBoxItem Style="{StaticResource ModernComboBoxItem}" Content="文档"/>
            </ComboBox>

            <ComboBox x:Name="WorkflowComboBox" 
                    Grid.Column="2"
                    Style="{StaticResource ModernComboBox}"
                    Margin="0,0,10,0"
                    SelectionChanged="WorkflowComboBox_SelectionChanged">
                <ComboBoxItem Style="{StaticResource ModernComboBoxItem}" Content="全部工作流" IsSelected="True"/>
            </ComboBox>

            <StackPanel Grid.Column="3" Orientation="Horizontal">
                <Button x:Name="TagFilterButton"
                        Content="标签筛选"
                        Style="{StaticResource ModernButton}"
                        Click="TagFilterButton_Click"
                        Margin="0,0,10,0"/>
                <Popup x:Name="TagFilterPopup" Placement="Bottom" StaysOpen="False" AllowsTransparency="True" PlacementTarget="{Binding ElementName=TagFilterButton}">
                    <Border Background="White" BorderBrush="#E4E7ED" BorderThickness="1" CornerRadius="6" Padding="12" >
                        <StackPanel Width="260">
                            <TextBlock Text="选择标签" FontWeight="Bold" Margin="0,0,0,8"/>
                            <ListBox x:Name="TagFilterListBox" SelectionMode="Multiple" Height="200"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                                <Button Content="确定" Style="{StaticResource ModernButton}" Width="70" Margin="0,0,8,0" Click="TagFilterConfirmButton_Click"/>
                                <Button Content="清空" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#606266" Width="70" Click="TagFilterClearButton_Click"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Popup>
            </StackPanel>

            <ToggleButton x:Name="CardViewToggle"
                           Grid.Column="5"
                           Content="卡片视图"
                           Style="{StaticResource ModernToggleButton}"
                           Background="Transparent"
                           Foreground="{StaticResource TextPrimaryBrush}"
                           Margin="0,0,10,0"
                           Click="CardViewToggle_Click"/>
            <Button x:Name="RefreshButton" 
                  Content="刷新" 
                  Grid.Column="6"
                  Style="{StaticResource ModernButton}"
                  Click="RefreshButton_Click"/>
        </Grid>

        <!-- 素材列表 -->
        <!-- 批量操作工具栏 -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,10">
            <TextBlock x:Name="SelectedCountText" Text="已选择 0 项" VerticalAlignment="Center" Margin="0,0,10,0" Foreground="{StaticResource TextSecondaryBrush}"/>
            <Button Content="星标所选" Style="{StaticResource ModernButton}" Margin="0,0,10,0" Click="BatchStarButton_Click"/>
            <Button Content="取消星标" Style="{StaticResource ModernButton}" Margin="0,0,10,0" Click="BatchUnstarButton_Click"/>
            <Button Content="设为公开" Style="{StaticResource ModernButton}" Margin="0,0,10,0" Click="BatchPublicButton_Click"/>
            <Button Content="设为私有" Style="{StaticResource ModernButton}" Margin="0,0,10,0" Click="BatchPrivateButton_Click"/>
            <Button Content="删除所选" Style="{StaticResource ModernButton}" Background="#F56C6C" Click="BatchDeleteButton_Click"/>
        </StackPanel>

        <!-- 主体左右布局：左侧本地文件，右侧云端素材 -->
        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300"/>
                <ColumnDefinition Width="10"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧本地文件 -->
            <Border Grid.Column="0" BorderBrush="#EEF1F5" BorderThickness="1" Background="White" Padding="10">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,8">
                        <Button Content="选择文件夹" Style="{StaticResource ModernButton}" Click="SelectFolderButton_Click"/>
                    </StackPanel>
                    <TextBlock x:Name="LocalFolderPathText" Grid.Row="1" Text="未选择文件夹" Foreground="{StaticResource TextSecondaryBrush}" TextTrimming="CharacterEllipsis"/>
                    <ListBox x:Name="LocalFilesListBox" Grid.Row="2" Margin="0,8,0,0" SelectionMode="Extended" PreviewMouseLeftButtonDown="LocalFilesListBox_PreviewMouseLeftButtonDown" MouseMove="LocalFilesListBox_MouseMove">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="40"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Border Grid.Column="0" Width="36" Height="36" Background="#F5F7FA" CornerRadius="4" VerticalAlignment="Center">
                                        <Image Source="{Binding Thumbnail}" Stretch="Uniform"/>
                                    </Border>
                                    <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!-- 分隔 -->
            <Grid Grid.Column="1" Background="#EEF1F5"/>

            <!-- 右侧云端素材 -->
            <Border x:Name="GridViewContainer" Grid.Column="2" BorderBrush="#EEF1F5" BorderThickness="1" Background="White" AllowDrop="True" Drop="MaterialsDropArea_Drop" DragOver="MaterialsDropArea_DragOver">
                <DataGrid x:Name="MaterialsDataGrid" 
                        Style="{StaticResource ModernDataGrid}"
                        AutoGenerateColumns="False"
                        IsReadOnly="True"
                        SelectionMode="Extended"
                        SelectionChanged="MaterialsDataGrid_SelectionChanged"
                        CanUserAddRows="False"
                        CanUserDeleteRows="False"
                        CanUserReorderColumns="True"
                        CanUserResizeColumns="True"
                        CanUserResizeRows="False"
                        CanUserSortColumns="True"
                        GridLinesVisibility="Horizontal"
                        HeadersVisibility="Column"
                        AlternatingRowBackground="#F5F7FA">
                    
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="60"/>
                        <DataGridTextColumn Header="文件名" Binding="{Binding OriginalFilename}" Width="200"/>
                        <DataGridTextColumn Header="文件类型" Binding="{Binding FileType}" Width="80"/>
                        <DataGridTextColumn Header="文件大小" Binding="{Binding FileSizeFormatted}" Width="100"/>
                        <DataGridTextColumn Header="分辨率" Binding="{Binding Width, StringFormat='{}{0}x{1}'}" Width="100"/>
                        <DataGridTextColumn Header="时长" Binding="{Binding Duration, StringFormat='{}{0}秒'}" Width="80"/>
                        <DataGridTextColumn Header="上传者" Binding="{Binding Uploader.Username}" Width="100"/>
                        <DataGridTextColumn Header="上传时间" Binding="{Binding UploadTime, StringFormat='yyyy-MM-dd HH:mm'}" Width="150"/>
                        <DataGridCheckBoxColumn Header="星标" Binding="{Binding IsStarred}" Width="60"/>
                        <DataGridCheckBoxColumn Header="公开" Binding="{Binding IsPublic}" Width="60"/>
                        <DataGridTextColumn Header="工作流" Binding="{Binding WorkflowId}" Width="80"/>
                        <DataGridTemplateColumn Header="操作" Width="260">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <Button Content="详情" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#409EFF" Padding="10,4" Margin="0,0,6,0" Click="ViewMaterial_Click"/>
                                        <Button Content="编辑" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#409EFF" Padding="10,4" Margin="0,0,6,0" Click="EditMaterial_Click"/>
                                        <Button Content="删除" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#F56C6C" Padding="10,4" Click="DeleteMaterial_Click"/>
                                        <Button Content="星标" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#E6A23C" Padding="10,4" Click="StarToggle_Click"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Border>

            <!-- 右侧卡片视图（与表格同列，为避免覆盖左侧） -->
            <ScrollViewer x:Name="CardViewContainer" Grid.Column="2" Visibility="Collapsed" AllowDrop="True" Drop="MaterialsDropArea_Drop" DragOver="MaterialsDropArea_DragOver">
                <ItemsControl x:Name="CardItemsControl">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Width="250" Margin="10" Background="White" BorderBrush="#E4E7ED" BorderThickness="1" CornerRadius="8">
                                <StackPanel>
                                    <Border Background="#F5F7FA" Height="140" CornerRadius="8,8,0,0">
                                        <Image Stretch="UniformToFill">
                                            <Image.Source>
                                                <BitmapImage UriSource="{Binding ThumbnailPath, ConverterCulture=en-US}" CreateOptions="IgnoreImageCache"/>
                                            </Image.Source>
                                        </Image>
                                    </Border>
                                    <StackPanel Margin="10">
                                        <TextBlock Text="{Binding OriginalFilename}" FontWeight="Bold" TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Text="{Binding FileType}" Foreground="{StaticResource TextSecondaryBrush}"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                                            <Button Content="详情" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#409EFF" Padding="10,4" Margin="0,0,6,0" Click="ViewMaterial_Click"/>
                                            <Button Content="编辑" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#409EFF" Padding="10,4" Margin="0,0,6,0" Click="EditMaterial_Click"/>
                                            <Button Content="删除" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#F56C6C" Padding="10,4" Click="DeleteMaterial_Click"/>
                                            <Button Content="星标" Style="{StaticResource ModernButton}" Background="Transparent" Foreground="#E6A23C" Padding="10,4" Click="StarToggle_Click"/>
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>

        

        <!-- 分页控件 -->
        <Grid Grid.Row="4" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="1" 
                      Orientation="Horizontal" 
                      VerticalAlignment="Center">
                <Button x:Name="PrevPageButton" 
                      Content="上一页" 
                      Style="{StaticResource ModernButton}"
                      Click="PrevPageButton_Click"
                      Margin="0,0,10,0"/>
                
                <TextBlock x:Name="PageInfoTextBlock" 
                         Text="第 1 页，共 1 页" 
                         VerticalAlignment="Center" 
                         Margin="0,0,10,0"
                         Foreground="#606266"/>
                
                <Button x:Name="NextPageButton" 
                      Content="下一页" 
                      Style="{StaticResource ModernButton}"
                      Click="NextPageButton_Click"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
